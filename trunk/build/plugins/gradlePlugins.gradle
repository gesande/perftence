import static org.gradle.logging.StyledTextOutput.Style

import org.gradle.logging.StyledTextOutput
import org.gradle.logging.StyledTextOutputFactory
import org.gradle.plugins.ide.eclipse.model.AbstractLibrary
import org.gradle.plugins.ide.eclipse.model.Classpath
import org.gradle.plugins.ide.eclipse.model.ClasspathEntry
import org.gradle.plugins.ide.eclipse.model.internal.FileReferenceFactory


apply plugin: 'groovy'
apply plugin: 'eclipse'

dependencies {
    compile gradleApi()
    groovy localGroovy()
}

eclipse {
    classpath {
        file {
            whenMerged {Classpath cp ->
                String gradleHome = gradle.getGradleHomeDir().absolutePath.replace(File.separator, '/')
                String gradleSrc = "${gradleHome}/src"
                def entrySourcePath = new FileReferenceFactory().fromPath(gradleSrc)
                def outputFactory = services.get(StyledTextOutputFactory).create("gradlePlugins.eclipse.classpath")
                cp.entries.each {ClasspathEntry entry ->
                    if ((entry in AbstractLibrary) && (entry.library.file.name.startsWith('gradle-'))) {
                        entry.sourcePath = entrySourcePath
                        outputFactory.withStyle(Style.Info).println("Forked for patch for ${entry}")
                    }
                }
            }
        }
    }
}
