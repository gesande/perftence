subprojects {
    apply plugin: "java"
    apply plugin: "eclipse"
    apply plugin: 'findbugs'
    apply plugin: 'pmd'
    apply plugin: "jdepend"
    
    ext {
        libProjects=[ 'log4j-1.2.16-1.0-BETA.jar', 'jcommon-1.0.15-1.0-BETA.jar', 'jfreechart-1.0.12-1.0-BETA.jar',  'junit-4.10-1.0-BETA.jar', 'commons-collections-3.2.1-1.0-BETA.jar', 'slf4j-api-1.6.1-1.0-BETA.jar', 'slf4j-log4j12-1.6.1-1.0-BETA.jar' ] 
    }
    
    eclipseJdt.inputFile=file('../build/template/for/eclipse/org.eclipse.jdt.core.prefs')
    eclipse.classpath.defaultOutputDir = file('target/classes')

    task "show-revision" << {
        new ByteArrayOutputStream().withStream { os ->
            def result = exec {
                executable = 'svn'
                args = ['info']
                standardOutput = os
            }
            def outputAsString = os.toString()
            def matchLastChangedRev = outputAsString =~ /Last Changed Rev: (\d+)/
            println "${matchLastChangedRev[0][1]}"
        }
    }

    task copyPmdSettings(type: Copy) { task ->
        from file('../build/template/for/pmd/.pmd')
        into task.project.projectDir
    }
    pmd.ruleSetFiles = files(".pmd")
    pmd.ignoreFailures = 'false'
    task pmdProductionCode(dependsOn: [ copyPmdSettings, pmdMain ])

    tasks.withType(FindBugs){
        ignoreFailures = false
    }
    [findbugsMain, findbugsTest]*.reports {
        xml.enabled false
        html.enabled true
    }

    [jdependMain, jdependTest]*.reports {
        xml.enabled true
        text.enabled false
    }

    jdependMain.doLast {
        File file = new File(jdepend.reportsDir, "main.xml");
        assert file.exists() && file.isFile(), "File '$file' must exist"
        def numberOfCycles = new XmlSlurper().parse(file).Cycles.Package.size()
        if (numberOfCycles > 0) {
            logger.error "We have detected $numberOfCycles cycles. Checkout report file: $file."
            assert numberOfCycles == 0, """We have detected $numberOfCycles cycles. Checkout report file: $file."""
        }
        else {
            logger.info "No cycles detected for project '$project.name' . Good work!"
        }
    }

    version = '1.0-BETA'

    task "show-version" << { println version }

    repositories { 
        flatDir { dirs 'lib' } 
        mavenCentral()
    }

    dependencies {
        compile fileTree(dir: 'lib', include: '*.jar', exclude: '*-sources.jar')
    }

    task "create-dirs" << {
        sourceSets*.java.srcDirs*.each { it.mkdirs() }
        sourceSets*.resources.srcDirs*.each { it.mkdirs() }
    }

    task "remove-target" << { delete("target") }

    task sourcesJar(type: Jar, dependsOn:classes) {
        classifier = 'sources'
        from sourceSets.main.allSource
    }

    task testSourcesJar(type: Jar, dependsOn:classes) {
        classifier = 'tests'
        from sourceSets.test.allSource
    }

    task javadocJar(type: Jar, dependsOn: javadoc) {
        classifier = 'javadoc'
        from javadoc.destinationDir
    }
 
    task "init-libs" << { task ->
        def libDir = new File(task.project.projectDir, 'lib')
        libDir.mkdirs()
        def libSourcesDir = new File(task.project.projectDir, 'lib-sources')
        libSourcesDir.mkdirs()
    }

    task continous(dependsOn: [ test, findbugsMain, pmdProductionCode, jdependMain ])
}

project(':log4j-1.2.16') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/log4j-1.2.16.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/apache-log4j-1.2.16.zip"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':junit-4.10') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/junit-4.10.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/junit-4.10-src.jar"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':jcommon-1.0.15') { prj ->
    prj.ext.libraryProjectLibrary="jcommon-1.0.15.jar"
    prj.ext.libraryProjectSources="jcommon-1.0.15.zip"
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/${prj.ext.libraryProjectLibrary}"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/${prj.ext.libraryProjectSources}"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':jfreechart-1.0.12') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/jfreechart-1.0.12.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/jfreechart-1.0.12.zip"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':slf4j-api-1.6.1') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/slf4j-api-1.6.1.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/slf4j-api-1.6.1-sources.jar"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':slf4j-log4j12-1.6.1') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/slf4j-log4j12-1.6.1.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/slf4j-log4j12-1.6.1-sources.jar"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':commons-collections-3.2.1') { prj ->
    eclipse {
        classpath {
            file {
                whenMerged { classpath ->
                    classpath.entries.removeAll { entry ->
                        entry.kind == 'lib'
                    }
                }
                withXml {
                    def node = it.asNode()
                    def componentPath = "${prj.projectDir}/lib/commons-collections-3.2.1.jar"
                    def componentSourcePath = "${prj.projectDir}/lib-sources/commons-collections-3.2.1-sources.jar"
                    node.appendNode('classpathentry', [kind: 'lib', path: componentPath, exported: true, sourcepath: componentSourcePath ])
                }
            }
        }
    }
}

project(':perftence') {
    apply from:'../build/plugins/emma.gradle'

    version = '1.0-BETA'

    tasks.withType(FindBugs){
        ignoreFailures = true
    }
    dependencies {
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':jfreechart-1.0.12')
        compile project(':jcommon-1.0.15')
        compile project(':perftence-bag')
        compile project(':perftence-fileutil')
        testCompile project(':junit-4.10')
        testRuntime project(':slf4j-log4j12-1.6.1')
        testRuntime project(':log4j-1.2.16')
    }

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-junit') {
    apply from:'../build/plugins/emma.gradle'

    version = '1.0'

    dependencies {
        compile project(':perftence')
        compile project(':perftence-api')
        compile project(':perftence-bag')
        compile project(':junit-4.10')
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':jfreechart-1.0.12')
        compile project(':jcommon-1.0.15')
        testRuntime project(':slf4j-log4j12-1.6.1')
        testRuntime project(':log4j-1.2.16')
    }

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':acceptance-tests') {
    dependencies {
        testCompile project(':perftence')
        testCompile project(':perftence-junit')
        testCompile project(':junit-4.10')
        testCompile project(':commons-collections-3.2.1')
        testCompile project(':slf4j-api-1.6.1')
        testCompile project(':jfreechart-1.0.12')
        testCompile project(':jcommon-1.0.15')
        testRuntime project(':slf4j-log4j12-1.6.1')
        testRuntime project(':log4j-1.2.16')
    }
}

project(':perftence-bag'){
    apply from:'../build/plugins/emma.gradle'

    version ='1.0'
    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        compile project(':commons-collections-3.2.1')
        compile project(':jcommon-1.0.15')
        testCompile project(':junit-4.10')
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-experimental') {
    apply from:'../build/plugins/emma.gradle'

    dependencies {
        compile project(':perftence')
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':junit-4.10')
        testCompile project(':perftence-junit')
        testCompile project(':jfreechart-1.0.12')
        testCompile project(':jcommon-1.0.15')
        testRuntime project(':slf4j-log4j12-1.6.1')
        testRuntime project(':log4j-1.2.16')
    }
}


project(':build') {
    eclipseJdt.inputFile=file('template/for/eclipse/org.eclipse.jdt.core.prefs')
}

project(':perftence-api') {
    apply from:'../build/plugins/emma.gradle'

    version = '1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        compile project(':perftence')
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':jfreechart-1.0.12')
        compile project(':jcommon-1.0.15')
        runtime project(':slf4j-log4j12-1.6.1')
        runtime project(':log4j-1.2.16')
        testCompile project(':junit-4.10')
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':mainentrypoint-example') {

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        compile project(':perftence')
        compile project(':perftence-api')
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':jfreechart-1.0.12')
        compile project(':jcommon-1.0.15')
        runtime project(':slf4j-log4j12-1.6.1')
        runtime project(':log4j-1.2.16')
    }
    task release(dependsOn: [ dist, sourcesJar ])
}

project(':fluent-based-example') {

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        testCompile project(':perftence')
        testCompile project(':perftence-junit')
        testCompile project(':commons-collections-3.2.1')
        testCompile project(':slf4j-api-1.6.1')
        testCompile project(':jfreechart-1.0.12')
        testCompile project(':jcommon-1.0.15')
        runtime project(':slf4j-log4j12-1.6.1')
        runtime project(':log4j-1.2.16')
    }
    task release(dependsOn: [ dist, sourcesJar ])
}

project(':agent-based-example') {

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        testCompile project(':perftence')
        testCompile project(':perftence-junit')
        testCompile project(':commons-collections-3.2.1')
        testCompile project(':slf4j-api-1.6.1')
        testCompile project(':jfreechart-1.0.12')
        testCompile project(':jcommon-1.0.15')
        runtime project(':slf4j-log4j12-1.6.1')
        runtime project(':log4j-1.2.16')
    }
    task release(dependsOn: [ dist, sourcesJar ])
}

project(':responsecode-summaryappender') {
    apply from:'../build/plugins/emma.gradle'

    version ='1.0'
    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        compile project(':perftence')
        compile project(':perftence-bag')
        compile project(':commons-collections-3.2.1')
        compile project(':jcommon-1.0.15')
        testCompile project(':junit-4.10')
    }
    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-junit-utils') {
    apply from:'../build/plugins/emma.gradle'
    version ='1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies { compile project(':junit-4.10') }

    task release(dependsOn: [ dist, sourcesJar ])
}

project ('filebased-reporting-proto') {
    apply from:'../build/plugins/emma.gradle'
    version ='1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }
    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        compile project(':perftence-linereader')
        compile project(':perftence')
        compile project(':commons-collections-3.2.1')
        compile project(':slf4j-api-1.6.1')
        compile project(':jfreechart-1.0.12')
        compile project(':jcommon-1.0.15')
        testCompile project(':perftence-junit')
        runtime project(':slf4j-log4j12-1.6.1')
        runtime project(':log4j-1.2.16')
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-linereader'){
    apply from:'../build/plugins/emma.gradle'
    version ='1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }
    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        testCompile project(':junit-4.10')
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-fileutil') {
    apply from:'../build/plugins/emma.gradle'
    version ='1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }

    dependencies {
        testCompile project(':junit-4.10')
    }

    task release(dependsOn: [ dist, sourcesJar ])
}

project(':perftence-classhelper') { 
    apply from:'../build/plugins/emma.gradle'
    version ='1.0'

    task('dist', type: Zip) {
        dependsOn 'jar'
        from jar.archivePath
        from configurations.runtime
        exclude project.ext.libProjects
    }

    artifacts {
        archives dist
        archives sourcesJar
    }
    dependencies {
        testCompile project(':slf4j-api-1.6.1')
        testCompile project(':junit-4.10')
        testRuntime project(':slf4j-log4j12-1.6.1')
        testRuntime project(':log4j-1.2.16')
        testCompile project(':junit-4.10')
    }
    task release(dependsOn: [ dist, sourcesJar ])

}

