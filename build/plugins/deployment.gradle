import org.gradle.api.file.FileTree
import org.gradle.api.tasks.Copy
import org.gradle.api.tasks.bundling.Tar

task copyDistribution(type: Copy) {
    def FileTree tree=fileTree("$projectDir")
    tree.include '**/build/distributions/*.zip'
    from 'COPYING'
    from tree.getFiles()
    into 'distribution'
}

task archiveDistribution(type: Tar) {
    outputs.upToDateWhen { false }

    def revision =""
    new ByteArrayOutputStream().withStream { os ->
        def result = exec {
            executable = 'svnversion'
            args = ['']
            standardOutput = os
        }
        revision = os.toString()
    }

    def artifactRevision="${artifactVersion}-R${revision}"
    println artifactRevision
    from 'distribution'
    destinationDir = file("$distributionDir")
    baseName = "perftence-distribution"
    version ="${artifactRevision}"
    extension = 'tar'
}

task copyDistributionSources(type: Copy) {
    def FileTree tree=fileTree("$projectDir")
    tree.include('**/build/libs/*sources.jar')
    from tree.getFiles()
    into 'distribution/sources'
}

task removeDistributionDir { doLast { delete("distribution") }}

task makeDistributionPackage(dependsOn: [
    copyDistribution,
    copyDistributionSources,
    archiveDistribution,
    removeDistributionDir]
)

